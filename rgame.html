<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alien Ship Heist - Working Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            overflow: hidden;
            background: #000;
            color: #e0e0e0;
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 100;
            pointer-events: none;
        }
        
        .hud-panel {
            background: rgba(10, 20, 40, 0.85);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(0, 150, 255, 0.5);
            min-width: 250px;
            backdrop-filter: blur(5px);
        }
        
        .hud-title {
            color: #4fc3f7;
            font-size: 1.1em;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(79, 195, 247, 0.3);
            padding-bottom: 5px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        
        .stat-label {
            color: #b0bec5;
        }
        
        .stat-value {
            color: #ffffff;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            margin: 5px 0 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s;
        }
        
        #health-bar { background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00); }
        #energy-bar { background: linear-gradient(90deg, #0066cc, #00ccff); }
        #integrity-bar { background: linear-gradient(90deg, #ff6f00, #ffca28); }
        
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            z-index: 90;
        }
        
        .crosshair-dot {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #00ffff;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 5px #00ffff;
        }
        
        #message-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 5, 15, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        
        .message-box {
            background: linear-gradient(135deg, rgba(10, 25, 50, 0.95), rgba(5, 15, 35, 0.98));
            border-radius: 15px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            border: 2px solid rgba(0, 200, 255, 0.5);
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 100, 255, 0.5);
        }
        
        .message-title {
            color: #18ffff;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(24, 255, 255, 0.5);
        }
        
        .message-text {
            color: #b0bec5;
            line-height: 1.6;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .btn {
            background: linear-gradient(135deg, #0066cc, #004499);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            border: 1px solid rgba(0, 150, 255, 0.5);
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #0088ff, #0066cc);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 136, 255, 0.4);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00c853, #009624);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #00e676, #00c853);
        }
        
        #controls-help {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(10, 20, 40, 0.85);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(0, 150, 255, 0.5);
            max-width: 300px;
        }
        
        .control-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
        }
        
        .key {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .hidden {
            display: none !important;
        }
        
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }
        
        .loading-bar {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            margin-top: 20px;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .loading-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #00ccff);
            width: 0%;
            transition: width 0.3s;
        }
        
        #radar {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            background: rgba(10, 20, 40, 0.85);
            border-radius: 50%;
            border: 2px solid rgba(0, 200, 255, 0.5);
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <!-- HUD -->
        <div id="hud">
            <div class="hud-panel">
                <div class="hud-title">VITAL SIGNS</div>
                <div class="stat-row">
                    <div class="stat-label">Health:</div>
                    <div id="health-value" class="stat-value">100%</div>
                </div>
                <div class="progress-bar">
                    <div id="health-bar" class="progress-fill" style="width: 100%"></div>
                </div>
                
                <div class="stat-row">
                    <div class="stat-label">Energy:</div>
                    <div id="energy-value" class="stat-value">100%</div>
                </div>
                <div class="progress-bar">
                    <div id="energy-bar" class="progress-fill" style="width: 100%"></div>
                </div>
                
                <div class="stat-row">
                    <div class="stat-label">Stealth:</div>
                    <div id="stealth-value" class="stat-value">ACTIVE</div>
                </div>
            </div>
            
            <div class="hud-panel">
                <div class="hud-title">MISSION STATUS</div>
                <div class="stat-row">
                    <div class="stat-label">Aliens:</div>
                    <div id="alien-count" class="stat-value">8</div>
                </div>
                
                <div class="stat-row">
                    <div class="stat-label">Distance:</div>
                    <div id="distance-value" class="stat-value">200m</div>
                </div>
                
                <div class="stat-row">
                    <div class="stat-label">Integrity:</div>
                    <div id="integrity-value" class="stat-value">85%</div>
                </div>
                <div class="progress-bar">
                    <div id="integrity-bar" class="progress-fill" style="width: 85%"></div>
                </div>
                
                <div class="stat-row">
                    <div class="stat-label">Ammo:</div>
                    <div id="ammo-value" class="stat-value">24/24</div>
                </div>
            </div>
        </div>
        
        <!-- Crosshair -->
        <div id="crosshair">
            <div class="crosshair-dot"></div>
        </div>
        
        <!-- Controls Help -->
        <div id="controls-help">
            <div style="color: #4fc3f7; margin-bottom: 10px;">CONTROLS:</div>
            <div class="control-item">
                <span>Move:</span>
                <span class="key">WASD</span>
            </div>
            <div class="control-item">
                <span>Look:</span>
                <span class="key">MOUSE</span>
            </div>
            <div class="control-item">
                <span>Fire:</span>
                <span class="key">CLICK</span>
            </div>
            <div class="control-item">
                <span>Interact:</span>
                <span class="key">E</span>
            </div>
            <div class="control-item">
                <span>Stealth:</span>
                <span class="key">SHIFT</span>
            </div>
            <div class="control-item">
                <span>Reload:</span>
                <span class="key">R</span>
            </div>
        </div>
        
        <!-- Radar -->
        <div id="radar"></div>
        
        <!-- Loading Screen -->
        <div id="loading">
            <div style="color: #18ffff; font-size: 2em; margin-bottom: 20px;">LOADING MISSION</div>
            <div class="loading-bar">
                <div id="loading-fill" class="loading-fill"></div>
            </div>
            <div id="loading-text" style="margin-top: 15px; color: #b0bec5;">Initializing systems...</div>
        </div>
        
        <!-- Message Overlay -->
        <div id="message-overlay" class="hidden">
            <div class="message-box">
                <div id="message-title" class="message-title">ALIEN SHIP HEIST</div>
                <div id="message-text" class="message-text">
                    Your ship was destroyed. Stranded in deep space, you must infiltrate the alien battleship, 
                    fight through multiple levels, steal their ship, and return home.
                    <br><br>
                    <strong>Mission:</strong> Infiltrate, eliminate, commandeer, escape.
                    <br><br>
                    <strong>Survival probability:</strong> 23%
                </div>
                <button id="start-btn" class="btn btn-primary">BEGIN MISSION</button>
                <button id="continue-btn" class="btn hidden">CONTINUE</button>
                <button id="next-btn" class="btn btn-primary hidden">NEXT LEVEL</button>
            </div>
        </div>
    </div>

    <!-- Three.js only - no complex dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        // ============== SIMPLIFIED GAME ENGINE ==============
        class AlienGame {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.gameState = {
                    level: 1,
                    health: 100,
                    energy: 100,
                    stealth: true,
                    aliens: 8,
                    distance: 200,
                    integrity: 85,
                    ammo: 24,
                    maxAmmo: 24,
                    gameStarted: false,
                    missionTime: 0,
                    levels: [
                        { title: "INFILTRATION", aliens: 8, distance: 200, desc: "Enter the alien ship" },
                        { title: "SABOTAGE", aliens: 12, distance: 150, desc: "Disable systems" },
                        { title: "COMMAND DECK", aliens: 6, distance: 50, desc: "Reach bridge" },
                        { title: "ESCAPE", aliens: 4, distance: 0, desc: "Steal ship and flee" }
                    ]
                };
                
                this.aliens = [];
                this.bullets = [];
                this.lastShot = 0;
                this.shotDelay = 300; // ms
                
                this.init();
            }
            
            async init() {
                // Update loading screen
                this.updateLoading("Initializing graphics...", 10);
                
                try {
                    // Create scene
                    this.scene = new THREE.Scene();
                    this.scene.fog = new THREE.Fog(0x000010, 10, 200);
                    
                    // Create camera
                    this.camera = new THREE.PerspectiveCamera(75, 
                        window.innerWidth / window.innerHeight, 
                        0.1, 1000);
                    this.camera.position.set(0, 2, 5);
                    
                    // Create renderer (SIMPLIFIED - no post-processing)
                    const canvas = document.getElementById('gameCanvas');
                    this.renderer = new THREE.WebGLRenderer({ 
                        canvas, 
                        antialias: true,
                        powerPreference: "high-performance"
                    });
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                    this.renderer.shadowMap.enabled = true;
                    this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                    
                    this.updateLoading("Creating environment...", 30);
                    
                    // Simple lighting
                    const ambientLight = new THREE.AmbientLight(0x333355, 0.6);
                    this.scene.add(ambientLight);
                    
                    const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    mainLight.position.set(10, 20, 5);
                    mainLight.castShadow = true;
                    this.scene.add(mainLight);
                    
                    this.updateLoading("Generating ship interior...", 60);
                    
                    // Create simple environment (no complex shaders)
                    this.createEnvironment();
                    
                    this.updateLoading("Creating alien entities...", 80);
                    
                    // Create aliens
                    this.createAliens();
                    
                    this.updateLoading("Finalizing systems...", 95);
                    
                    // Setup controls
                    this.setupControls();
                    
                    // Start game loop
                    this.animate();
                    
                    // Hide loading screen
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                        this.showMessage("ALIEN SHIP HEIST", "Press BEGIN MISSION to start", true, false, false);
                    }, 500);
                    
                    console.log("Game initialized successfully!");
                    
                } catch (error) {
                    console.error("Initialization error:", error);
                    this.updateLoading(`Error: ${error.message}`, 100);
                    alert("Game initialization failed. Check console for details.");
                }
            }
            
            updateLoading(text, percent) {
                document.getElementById('loading-text').textContent = text;
                document.getElementById('loading-fill').style.width = `${percent}%`;
            }
            
            createEnvironment() {
                // Floor
                const floorGeometry = new THREE.PlaneGeometry(100, 100);
                const floorMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x1a1a33,
                    roughness: 0.8,
                    metalness: 0.3
                });
                const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                floor.rotation.x = -Math.PI / 2;
                floor.receiveShadow = true;
                this.scene.add(floor);
                
                // Walls
                const wallGeometry = new THREE.BoxGeometry(100, 20, 2);
                const wallMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x222244,
                    roughness: 0.7,
                    metalness: 0.4
                });
                
                // Add walls around
                const walls = [
                    { pos: [0, 10, -50], rot: 0 },
                    { pos: [0, 10, 50], rot: 0 },
                    { pos: [-50, 10, 0], rot: Math.PI/2 },
                    { pos: [50, 10, 0], rot: Math.PI/2 }
                ];
                
                walls.forEach(wall => {
                    const wallMesh = new THREE.Mesh(wallGeometry, wallMaterial);
                    wallMesh.position.set(...wall.pos);
                    wallMesh.rotation.y = wall.rot;
                    wallMesh.castShadow = true;
                    wallMesh.receiveShadow = true;
                    this.scene.add(wallMesh);
                });
                
                // Alien consoles
                const consoleGeometry = new THREE.BoxGeometry(4, 2, 1);
                const consoleMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x003322,
                    emissive: 0x002211,
                    emissiveIntensity: 0.3
                });
                
                for (let i = 0; i < 8; i++) {
                    const console = new THREE.Mesh(consoleGeometry, consoleMaterial);
                    console.position.set(
                        (Math.random() - 0.5) * 80,
                        1,
                        (Math.random() - 0.5) * 80
                    );
                    console.castShadow = true;
                    this.scene.add(console);
                    
                    // Add screen
                    const screenGeometry = new THREE.PlaneGeometry(3.5, 1);
                    const screenMaterial = new THREE.MeshBasicMaterial({ 
                        color: 0x00ffaa,
                        transparent: true,
                        opacity: 0.6
                    });
                    const screen = new THREE.Mesh(screenGeometry, screenMaterial);
                    screen.position.set(0, 0, 0.6);
                    console.add(screen);
                }
                
                // Alien ship in center
                const shipGeometry = new THREE.ConeGeometry(5, 10, 8);
                const shipMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xaa22ff,
                    emissive: 0x330066,
                    emissiveIntensity: 0.5,
                    roughness: 0.3,
                    metalness: 0.8
                });
                this.alienShip = new THREE.Mesh(shipGeometry, shipMaterial);
                this.alienShip.position.set(0, 5, 0);
                this.alienShip.rotation.x = Math.PI / 2;
                this.alienShip.castShadow = true;
                this.scene.add(this.alienShip);
                
                // Add glow
                const glowGeometry = new THREE.SphereGeometry(7, 16, 16);
                const glowMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0x4400ff,
                    transparent: true,
                    opacity: 0.1
                });
                const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                this.alienShip.add(glow);
                
                // Add stars in background
                this.createStars();
            }
            
            createStars() {
                const starCount = 1000;
                const stars = new THREE.BufferGeometry();
                const positions = new Float32Array(starCount * 3);
                
                for (let i = 0; i < starCount * 3; i += 3) {
                    positions[i] = (Math.random() - 0.5) * 1000;
                    positions[i + 1] = (Math.random() - 0.5) * 1000;
                    positions[i + 2] = (Math.random() - 0.5) * 1000;
                }
                
                stars.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                
                const starMaterial = new THREE.PointsMaterial({
                    color: 0xffffff,
                    size: 1.5,
                    sizeAttenuation: true
                });
                
                const starField = new THREE.Points(stars, starMaterial);
                this.scene.add(starField);
            }
            
            createAliens() {
                const alienGeometry = new THREE.BoxGeometry(0.8, 2, 0.8);
                const alienMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x4a0066,
                    emissive: 0x220033,
                    emissiveIntensity: 0.2
                });
                
                for (let i = 0; i < this.gameState.aliens; i++) {
                    const alien = new THREE.Mesh(alienGeometry, alienMaterial);
                    alien.position.set(
                        (Math.random() - 0.5) * 60,
                        1,
                        (Math.random() - 0.5) * 60
                    );
                    alien.castShadow = true;
                    alien.userData = {
                        id: i,
                        health: 100,
                        speed: 0.02 + Math.random() * 0.03,
                        direction: new THREE.Vector3(
                            Math.random() - 0.5,
                            0,
                            Math.random() - 0.5
                        ).normalize()
                    };
                    
                    this.scene.add(alien);
                    this.aliens.push(alien);
                }
            }
            
            setupControls() {
                // Movement flags
                this.move = {
                    forward: false,
                    backward: false,
                    left: false,
                    right: false
                };
                
                // Mouse look
                this.mouse = {
                    x: 0,
                    y: 0,
                    sensitivity: 0.002
                };
                
                // Event listeners
                document.addEventListener('keydown', (e) => this.onKeyDown(e));
                document.addEventListener('keyup', (e) => this.onKeyUp(e));
                document.addEventListener('mousedown', (e) => this.onMouseDown(e));
                document.addEventListener('mousemove', (e) => this.onMouseMove(e));
                
                // UI buttons
                document.getElementById('start-btn').addEventListener('click', () => this.startGame());
                document.getElementById('continue-btn').addEventListener('click', () => this.continueGame());
                document.getElementById('next-btn').addEventListener('click', () => this.nextLevel());
                
                // Window resize
                window.addEventListener('resize', () => this.onResize());
                
                // Lock pointer on click
                document.getElementById('gameCanvas').addEventListener('click', () => {
                    this.lockPointer();
                });
            }
            
            lockPointer() {
                const canvas = document.getElementById('gameCanvas');
                if (canvas.requestPointerLock) {
                    canvas.requestPointerLock();
                }
            }
            
            onKeyDown(e) {
                if (!this.gameState.gameStarted) return;
                
                switch(e.key.toLowerCase()) {
                    case 'w': this.move.forward = true; break;
                    case 's': this.move.backward = true; break;
                    case 'a': this.move.left = true; break;
                    case 'd': this.move.right = true; break;
                    case 'shift': this.toggleStealth(); break;
                    case 'e': this.interact(); break;
                    case 'r': this.reload(); break;
                    case ' ': this.jump(); break;
                }
            }
            
            onKeyUp(e) {
                switch(e.key.toLowerCase()) {
                    case 'w': this.move.forward = false; break;
                    case 's': this.move.backward = false; break;
                    case 'a': this.move.left = false; break;
                    case 'd': this.move.right = false; break;
                }
            }
            
            onMouseDown(e) {
                if (!this.gameState.gameStarted) return;
                
                if (e.button === 0) { // Left click
                    this.fireWeapon();
                }
            }
            
            onMouseMove(e) {
                if (!document.pointerLockElement) return;
                
                this.mouse.x += e.movementX * this.mouse.sensitivity;
                this.mouse.y += e.movementY * this.mouse.sensitivity;
                
                // Clamp vertical look
                this.mouse.y = Math.max(-Math.PI/2, Math.min(Math.PI/2, this.mouse.y));
            }
            
            onResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                
                // Update game time
                this.gameState.missionTime += 0.016;
                
                // Update camera rotation from mouse
                if (this.camera) {
                    this.camera.rotation.order = 'YXZ';
                    this.camera.rotation.y = -this.mouse.x;
                    this.camera.rotation.x = -this.mouse.y;
                    
                    // Simple movement
                    const speed = 0.1;
                    const dir = new THREE.Vector3();
                    
                    if (this.move.forward) dir.z -= speed;
                    if (this.move.backward) dir.z += speed;
                    if (this.move.left) dir.x -= speed;
                    if (this.move.right) dir.x += speed;
                    
                    // Apply movement relative to camera direction
                    dir.applyEuler(this.camera.rotation);
                    this.camera.position.add(dir);
                    
                    // Keep camera above ground
                    this.camera.position.y = Math.max(1, this.camera.position.y);
                }
                
                // Update alien ship rotation
                if (this.alienShip) {
                    this.alienShip.rotation.z += 0.01;
                }
                
                // Update aliens
                this.updateAliens();
                
                // Update bullets
                this.updateBullets();
                
                // Update radar
                this.updateRadar();
                
                // Render
                if (this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
            }
            
            updateAliens() {
                this.aliens.forEach((alien, index) => {
                    if (!alien.userData) return;
                    
                    // Move alien
                    alien.position.add(alien.userData.direction.clone().multiplyScalar(alien.userData.speed));
                    
                    // Bounce off walls
                    if (Math.abs(alien.position.x) > 45 || Math.abs(alien.position.z) > 45) {
                        alien.userData.direction.x *= -1;
                        alien.userData.direction.z *= -1;
                    }
                    
                    // Face movement direction
                    alien.lookAt(alien.position.clone().add(alien.userData.direction));
                    
                    // Gentle bounce
                    alien.position.y = 1 + Math.sin(this.gameState.missionTime * 2 + index) * 0.1;
                });
            }
            
            updateBullets() {
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    bullet.position.add(bullet.userData.velocity);
                    
                    // Check collision with aliens
                    for (let j = this.aliens.length - 1; j >= 0; j--) {
                        const alien = this.aliens[j];
                        if (bullet.position.distanceTo(alien.position) < 1.5) {
                            // Hit alien
                            this.scene.remove(bullet);
                            this.bullets.splice(i, 1);
                            
                            this.scene.remove(alien);
                            this.aliens.splice(j, 1);
                            this.gameState.aliens--;
                            
                            this.addLog(`Alien eliminated! ${this.gameState.aliens} remaining`);
                            break;
                        }
                    }
                    
                    // Remove if too far
                    if (bullet.position.length() > 100) {
                        this.scene.remove(bullet);
                        this.bullets.splice(i, 1);
                    }
                }
            }
            
            updateRadar() {
                const radar = document.getElementById('radar');
                const ctx = radar.getContext('2d');
                
                // Clear
                ctx.clearRect(0, 0, 150, 150);
                
                // Draw circle
                ctx.beginPath();
                ctx.arc(75, 75, 70, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(5, 15, 35, 0.9)';
                ctx.fill();
                ctx.strokeStyle = 'rgba(0, 200, 255, 0.5)';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Draw player (center)
                ctx.beginPath();
                ctx.arc(75, 75, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#00ff00';
                ctx.fill();
                
                // Draw aliens
                ctx.fillStyle = '#ff0000';
                this.aliens.forEach(alien => {
                    // Simplified radar positioning
                    const x = 75 + (alien.position.x / 100) * 70;
                    const y = 75 + (alien.position.z / 100) * 70;
                    
                    if (x > 5 && x < 145 && y > 5 && y < 145) {
                        ctx.beginPath();
                        ctx.arc(x, y, 3, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
                
                // Draw alien ship
                ctx.fillStyle = '#aa22ff';
                ctx.beginPath();
                ctx.arc(75, 25, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw sweep line
                const sweepAngle = (this.gameState.missionTime * 2) % (Math.PI * 2);
                ctx.strokeStyle = 'rgba(0, 255, 255, 0.6)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(75, 75);
                ctx.lineTo(75 + Math.cos(sweepAngle) * 70, 75 + Math.sin(sweepAngle) * 70);
                ctx.stroke();
            }
            
            // ============== GAME ACTIONS ==============
            
            startGame() {
                this.gameState.gameStarted = true;
                document.getElementById('message-overlay').classList.add('hidden');
                this.addLog("Mission started. Good luck!");
                
                // Start game simulation
                this.startSimulation();
            }
            
            startSimulation() {
                // Simulate gameplay events
                setInterval(() => {
                    if (!this.gameState.gameStarted) return;
                    
                    // Random events
                    if (Math.random() < 0.02 && this.gameState.aliens > 0) {
                        if (!this.gameState.stealth) {
                            this.gameState.health = Math.max(0, this.gameState.health - 5);
                            this.addLog("Taking fire! Health decreased.");
                        }
                    }
                    
                    // Reduce distance over time
                    if (Math.random() < 0.05 && this.gameState.distance > 0) {
                        this.gameState.distance = Math.max(0, this.gameState.distance - 5);
                    }
                    
                    // Check level completion
                    if (this.gameState.aliens <= 0 && this.gameState.distance <= 10) {
                        this.completeLevel();
                    }
                    
                    // Update UI
                    this.updateUI();
                    
                }, 1000);
            }
            
            updateUI() {
                document.getElementById('health-value').textContent = `${this.gameState.health}%`;
                document.getElementById('health-bar').style.width = `${this.gameState.health}%`;
                
                document.getElementById('energy-value').textContent = `${this.gameState.energy}%`;
                document.getElementById('energy-bar').style.width = `${this.gameState.energy}%`;
                
                document.getElementById('stealth-value').textContent = this.gameState.stealth ? 'ACTIVE' : 'INACTIVE';
                document.getElementById('stealth-value').style.color = this.gameState.stealth ? '#00ff00' : '#ff0000';
                
                document.getElementById('alien-count').textContent = this.gameState.aliens;
                document.getElementById('distance-value').textContent = `${this.gameState.distance}m`;
                document.getElementById('integrity-value').textContent = `${this.gameState.integrity}%`;
                document.getElementById('integrity-bar').style.width = `${this.gameState.integrity}%`;
                document.getElementById('ammo-value').textContent = `${this.gameState.ammo}/${this.gameState.maxAmmo}`;
            }
            
            fireWeapon() {
                const now = Date.now();
                if (now - this.lastShot < this.shotDelay || this.gameState.ammo <= 0) return;
                
                this.lastShot = now;
                this.gameState.ammo--;
                
                // Create bullet
                const bulletGeometry = new THREE.SphereGeometry(0.1, 8, 8);
                const bulletMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff });
                const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);
                
                // Position at camera
                bullet.position.copy(this.camera.position);
                
                // Direction camera is facing
                const direction = new THREE.Vector3(0, 0, -1);
                direction.applyQuaternion(this.camera.quaternion);
                direction.multiplyScalar(0.5); // Speed
                
                bullet.userData = { velocity: direction };
                this.scene.add(bullet);
                this.bullets.push(bullet);
                
                this.addLog(`Weapon fired. Ammo: ${this.gameState.ammo}/${this.gameState.maxAmmo}`);
                
                // Remove after 2 seconds
                setTimeout(() => {
                    const index = this.bullets.indexOf(bullet);
                    if (index > -1) {
                        this.scene.remove(bullet);
                        this.bullets.splice(index, 1);
                    }
                }, 2000);
            }
            
            reload() {
                if (this.gameState.ammo < this.gameState.maxAmmo) {
                    this.gameState.ammo = this.gameState.maxAmmo;
                    this.addLog("Weapon reloaded");
                }
            }
            
            toggleStealth() {
                this.gameState.stealth = !this.gameState.stealth;
                this.addLog(`Stealth ${this.gameState.stealth ? 'activated' : 'deactivated'}`);
            }
            
            interact() {
                // Check if near alien ship
                const distanceToShip = this.camera.position.distanceTo(this.alienShip.position);
                if (distanceToShip < 15) {
                    this.gameState.distance = Math.max(0, this.gameState.distance - 20);
                    this.addLog("Accessing alien ship systems...");
                } else {
                    this.addLog("Nothing to interact with here");
                }
            }
            
            jump() {
                // Simple jump
                if (this.camera.position.y < 2) {
                    this.camera.position.y += 2;
                    setTimeout(() => {
                        this.camera.position.y = Math.max(1, this.camera.position.y - 2);
                    }, 300);
                }
            }
            
            completeLevel() {
                const currentLevel = this.gameState.level;
                
                if (currentLevel < 4) {
                    this.showMessage(
                        `LEVEL ${currentLevel} COMPLETE`,
                        `Prepare for next phase: ${this.gameState.levels[currentLevel].title}`,
                        false, false, true
                    );
                } else {
                    this.showMessage(
                        "MISSION ACCOMPLISHED!",
                        "You have stolen the alien ship and are returning to Earth.",
                        false, true, false
                    );
                }
            }
            
            nextLevel() {
                if (this.gameState.level < 4) {
                    this.gameState.level++;
                    const level = this.gameState.levels[this.gameState.level - 1];
                    
                    // Reset level stats
                    this.gameState.aliens = level.aliens;
                    this.gameState.distance = level.distance;
                    
                    // Heal player
                    this.gameState.health = Math.min(100, this.gameState.health + 30);
                    this.gameState.energy = Math.min(100, this.gameState.energy + 40);
                    
                    // Remove old aliens
                    this.aliens.forEach(alien => this.scene.remove(alien));
                    this.aliens = [];
                    
                    // Create new aliens
                    this.createAliens();
                    
                    this.addLog(`Starting ${level.title}: ${level.desc}`);
                    document.getElementById('message-overlay').classList.add('hidden');
                }
            }
            
            continueGame() {
                // Restart current level
                const level = this.gameState.levels[this.gameState.level - 1];
                
                this.gameState.health = 100;
                this.gameState.energy = 100;
                this.gameState.ammo = this.gameState.maxAmmo;
                this.gameState.aliens = level.aliens;
                this.gameState.distance = level.distance;
                
                // Remove old aliens
                this.aliens.forEach(alien => this.scene.remove(alien));
                this.aliens = [];
                
                // Create new aliens
                this.createAliens();
                
                this.addLog("Mission restarted");
                document.getElementById('message-overlay').classList.add('hidden');
            }
            
            showMessage(title, text, showStart, showContinue, showNext) {
                document.getElementById('message-title').textContent = title;
                document.getElementById('message-text').textContent = text;
                
                document.getElementById('start-btn').classList.toggle('hidden', !showStart);
                document.getElementById('continue-btn').classList.toggle('hidden', !showContinue);
                document.getElementById('next-btn').classList.toggle('hidden', !showNext);
                
                document.getElementById('message-overlay').classList.remove('hidden');
            }
            
            addLog(message) {
                console.log(`[GAME] ${message}`);
            }
        }
        
        // ============== START THE GAME ==============
        window.addEventListener('load', () => {
            console.log("Starting Alien Ship Heist game...");
            const game = new AlienGame();
            window.game = game; // Make accessible in console for debugging
        });
        
        // Make testing functions available
        function testFire() {
            if (window.game) window.game.fireWeapon();
        }
        
        function testReload() {
            if (window.game) window.game.reload();
        }
        
        function testStealth() {
            if (window.game) window.game.toggleStealth();
        }
        
        function testComplete() {
            if (window.game) window.game.completeLevel();
        }
    </script>
</body>
</html>
